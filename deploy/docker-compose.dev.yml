# Development Docker Compose for Writer
# Includes hot-reload, debug tools (pgAdmin, Redis Commander), and local storage

services:
    # Next.js Application (Development Mode)
    app:
        build:
            context: ..
            dockerfile: deploy/Dockerfile
            target: builder
        container_name: writer-app-dev
        restart: unless-stopped
        command: npm run dev
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            qdrant:
                condition: service_started
            tika:
                condition: service_started
            minio:
                condition: service_healthy
        environment:
            # Database
            DATABASE_URL: postgresql://${POSTGRES_USER:-writer}:${POSTGRES_PASSWORD:-writer}@postgres:5432/${POSTGRES_DB:-writer}

            # Redis (no password in dev)
            REDIS_URL: redis://redis:6379

            # Qdrant (no auth in dev)
            QDRANT_URL: http://qdrant:6333
            QDRANT_GRPC_URL: http://qdrant:6334

            # Tika
            TIKA_URL: http://tika:9998

            # MinIO
            MINIO_ENDPOINT: minio
            MINIO_PORT: 9000
            MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
            MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
            MINIO_BUCKET: ${MINIO_BUCKET:-writer-uploads}
            MINIO_USE_SSL: "false"

            # App
            NODE_ENV: development
            PORT: 3000

            # LLM
            OPENAI_API_KEY: ${OPENAI_API_KEY:-}
            ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

            # Auth
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-dev-secret-change-in-prod}

        ports:
            - "3000:3000"
        volumes:
            # Hot-reload for development
            - ../src:/app/src:ro
            - ../public:/app/public:ro
            - ../prisma:/app/prisma:ro
            - /app/node_modules
            - /app/.next
        networks:
            - writer-network

    # PostgreSQL 17 Database
    postgres:
        image: postgres:17-alpine
        container_name: writer-postgres-dev
        restart: unless-stopped
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-writer}
            POSTGRES_USER: ${POSTGRES_USER:-writer}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-writer}
            PGDATA: /var/lib/postgresql/data/pgdata
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER:-writer} -d ${POSTGRES_DB:-writer}",
                ]
            interval: 5s
            timeout: 3s
            retries: 5
        networks:
            - writer-network

    # Redis 7 (No password for dev)
    redis:
        image: redis:7-alpine
        container_name: writer-redis-dev
        restart: unless-stopped
        command: redis-server --save 60 1 --loglevel warning
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 3s
            retries: 5
        networks:
            - writer-network

    # Qdrant Vector Database (No auth for dev)
    qdrant:
        image: qdrant/qdrant:latest
        container_name: writer-qdrant-dev
        restart: unless-stopped
        environment:
            QDRANT__SERVICE__GRPC_PORT: 6334
            QDRANT__SERVICE__HTTP_PORT: 6333
            QDRANT__LOG_LEVEL: DEBUG
        ports:
            - "6333:6333"
            - "6334:6334"
        volumes:
            - qdrant_data:/qdrant/storage
        networks:
            - writer-network

    # Apache Tika (Document Parser)
    tika:
        image: apache/tika:latest-full
        container_name: writer-tika-dev
        restart: unless-stopped
        ports:
            - "9998:9998"
        environment:
            TIKA_SERVER_MIN_HEAP: 256m
            TIKA_SERVER_MAX_HEAP: 512m
            TIKA_LOG_LEVEL: INFO
        networks:
            - writer-network

    # MinIO (S3-compatible storage for dev)
    minio:
        image: minio/minio:latest
        container_name: writer-minio-dev
        restart: unless-stopped
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
        ports:
            - "9000:9000"
            - "9001:9001"
        volumes:
            - minio_data:/data
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - writer-network

    # MinIO Setup (Create initial bucket)
    minio-setup:
        image: minio/mc:latest
        container_name: writer-minio-setup-dev
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            sleep 5 &&
            mc alias set minio http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin} &&
            mc mb minio/${MINIO_BUCKET:-writer-uploads} --ignore-existing &&
            mc anonymous set download minio/${MINIO_BUCKET:-writer-uploads}
            "
        networks:
            - writer-network

    # PgAdmin (Database management - dev only)
    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: writer-pgadmin-dev
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@writer.dev}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
            PGADMIN_CONFIG_SERVER_MODE: "False"
        ports:
            - "5050:80"
        volumes:
            - pgadmin_data:/var/lib/pgadmin
        networks:
            - writer-network

    # Redis Commander (Redis management - dev only)
    redis-commander:
        image: rediscommander/redis-commander:latest
        platform: linux/amd64
        container_name: writer-redis-commander-dev
        restart: unless-stopped
        depends_on:
            redis:
                condition: service_healthy
        environment:
            REDIS_HOSTS: local:redis:6379
        ports:
            - "8081:8081"
        networks:
            - writer-network

volumes:
    postgres_data:
        driver: local
    redis_data:
        driver: local
    qdrant_data:
        driver: local
    minio_data:
        driver: local
    pgadmin_data:
        driver: local

networks:
    writer-network:
        driver: bridge
